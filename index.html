<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å…°å®‡æ˜•çš„ç½‘é¡µ - ç“¶é¢ˆå·¥åºåˆ†æ</title>
    <style>
        .chat-container {
            width: 600px;
            margin: 50px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        .chat-messages {
            height: 400px;
            padding: 10px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user {
            background-color: #e6f7ff;
            text-align: right;
            margin-left: auto;
        }
        .assistant {
            background-color: #f5f5f5;
            text-align: left;
            margin-right: auto;
        }
        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
        }
        #input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            border-right: 1px solid #ccc;
        }
        #send {
            padding: 0 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #send:hover {
            background-color: #0056b3;
        }
        .tip {
            font-size: 12px;
            color: #666;
            padding: 5px 10px;
            background-color: #fafafa;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- æç¤ºç”¨æˆ·è¾“å…¥æ ¼å¼ -->
        <div class="tip">
            è¯·æŒ‰æ ¼å¼è¾“å…¥å·¥åºä¿¡æ¯ï¼ˆè¾“å…¥â€œå¼€å§‹åˆ†æâ€è§¦å‘è®¡ç®—ï¼‰ï¼š<br>
            æ ¼å¼ç¤ºä¾‹ï¼šå·¥åºå,è€—æ—¶(åˆ†é’Ÿ),å‰ç½®å·¥åº1,å‰ç½®å·¥åº2ï¼ˆæ— å‰ç½®å·¥åºåˆ™ç•™ç©ºï¼‰<br>
            ä¾‹å¦‚ï¼šæ³¨å¡‘ç¯åº§,5ï¼›ç„Šæ¥çº¿è·¯,8,æ³¨å¡‘ç¯åº§ï¼›ç»„è£…ç¯æ†,6,æ³¨å¡‘ç¯åº§
        </div>
        <div class="chat-messages" id="messages"></div>
        <div class="chat-input">
            <input type="text" id="input" placeholder="æŒ‰æ ¼å¼è¾“å…¥å·¥åºï¼Œè¾“å…¥â€œå¼€å§‹åˆ†æâ€è®¡ç®—ç“¶é¢ˆ...">
            <button id="send">å‘é€</button>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        // å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„å·¥åºæ•°æ®
        let processes = {};

        // ---------------------- æ ¸å¿ƒï¼šç“¶é¢ˆå·¥åºåˆ†æç®—æ³• ----------------------
        // æ£€æŸ¥å¾ªç¯ä¾èµ–
        function checkCircularDependency(processes) {
            const visited = new Set();
            const recStack = new Set();

            function dfs(process) {
                if (recStack.has(process)) return true;
                if (visited.has(process)) return false;
                visited.add(process);
                recStack.add(process);
                const [_, predecessors] = processes[process] || [0, []];
                for (const prev of predecessors) {
                    if (dfs(prev)) return true;
                }
                recStack.delete(process);
                return false;
            }

            for (const process of Object.keys(processes)) {
                if (dfs(process)) return true;
            }
            return false;
        }

        // æŸ¥æ‰¾ç“¶é¢ˆå·¥åº
        function findBottleneck(processes) {
            // 1. æ‹“æ‰‘æ’åº
            const sortedProcesses = [];
            const visited = new Set();

            function dfs(process) {
                if (visited.has(process)) return;
                const [_, predecessors] = processes[process] || [0, []];
                for (const prev of predecessors) {
                    dfs(prev);
                }
                visited.add(process);
                sortedProcesses.push(process);
            }

            for (const process of Object.keys(processes)) {
                dfs(process);
            }

            // 2. è®¡ç®—æœ€æ—©å¼€å§‹/å®Œæˆæ—¶é—´
            const es = {}; // æœ€æ—©å¼€å§‹æ—¶é—´
            const ef = {}; // æœ€æ—©å®Œæˆæ—¶é—´
            Object.keys(processes).forEach(p => es[p] = 0);

            for (const p of sortedProcesses) {
                const [duration, predecessors] = processes[p];
                if (predecessors.length === 0) {
                    ef[p] = duration;
                } else {
                    es[p] = Math.max(...predecessors.map(prev => ef[prev]));
                    ef[p] = es[p] + duration;
                }
            }

            // 3. è®¡ç®—æœ€æ™šå®Œæˆ/å¼€å§‹æ—¶é—´
            const totalTime = Math.max(...Object.values(ef));
            const lf = {}; // æœ€æ™šå®Œæˆæ—¶é—´
            const ls = {}; // æœ€æ™šå¼€å§‹æ—¶é—´
            Object.keys(processes).forEach(p => lf[p] = totalTime);

            for (const p of sortedProcesses.reverse()) {
                const [duration, _] = processes[p];
                // æ‰¾ååºå·¥åº
                const successors = Object.keys(processes).filter(
                    s => processes[s][1].includes(p)
                );

                if (successors.length === 0) {
                    ls[p] = lf[p] - duration;
                } else {
                    lf[p] = Math.min(...successors.map(s => ls[s]));
                    ls[p] = lf[p] - duration;
                }
            }

            // 4. ç¡®å®šå…³é”®è·¯å¾„å’Œç“¶é¢ˆ
            const criticalPath = Object.keys(processes).filter(p => es[p] === ls[p]);
            if (criticalPath.length === 0) return null;

            // å…³é”®è·¯å¾„ä¸­è€—æ—¶æœ€é•¿çš„å·¥åº
            const bottleneck = criticalPath.reduce((maxP, p) => {
                return processes[p][0] > processes[maxP][0] ? p : maxP;
            }, criticalPath[0]);

            return {
                totalTime: totalTime.toFixed(1),
                criticalPath: criticalPath.join(' â†’ '),
                bottleneck: bottleneck,
                bottleneckTime: processes[bottleneck][0].toFixed(1)
            };
        }
        // -------------------------------------------------------------------

        // å‘é€æ¶ˆæ¯å‡½æ•°
        function sendMessage(content) {
            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.textContent = content;
            messagesContainer.appendChild(userMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // 2. å¤„ç†ç”¨æˆ·è¾“å…¥ï¼ˆåŒºåˆ†â€œæ·»åŠ å·¥åºâ€å’Œâ€œå¼€å§‹åˆ†æâ€ï¼‰
            let assistantReply = '';
            if (content.trim() === 'å¼€å§‹åˆ†æ') {
                // è§¦å‘åˆ†æé€»è¾‘
                if (Object.keys(processes).length === 0) {
                    assistantReply = 'è¿˜æ²¡æœ‰è¾“å…¥ä»»ä½•å·¥åºå“¦ï¼è¯·å…ˆæŒ‰æ ¼å¼è¾“å…¥è‡³å°‘ä¸€ä¸ªå·¥åºï¼ˆä¾‹å¦‚ï¼šæ³¨å¡‘ç¯åº§,5ï¼‰ã€‚';
                } else if (checkCircularDependency(processes)) {
                    assistantReply = 'å‘ç°å·¥åºå­˜åœ¨å¾ªç¯ä¾èµ–ï¼ˆæ¯”å¦‚Aä¾èµ–Bï¼ŒBåˆä¾èµ–Aï¼‰ï¼Œè¯·ä¿®æ­£å·¥åºå…³ç³»åé‡æ–°åˆ†æï¼';
                } else {
                    const result = findBottleneck(processes);
                    if (result) {
                        assistantReply = `
                        ğŸ” ç“¶é¢ˆå·¥åºåˆ†æç»“æœï¼š
                        1. æ€»ç”Ÿäº§æ—¶é—´ï¼š${result.totalTime} åˆ†é’Ÿ
                        2. å…³é”®è·¯å¾„ï¼ˆæœ€é•¿ç”Ÿäº§è·¯å¾„ï¼‰ï¼š${result.criticalPath}
                        3. ç“¶é¢ˆå·¥åºï¼š${result.bottleneck}
                        4. ç“¶é¢ˆè€—æ—¶ï¼š${result.bottleneckTime} åˆ†é’Ÿ
                        ğŸ’¡ å»ºè®®ï¼šä¼˜å…ˆä¼˜åŒ–ç“¶é¢ˆå·¥åºï¼ˆå¦‚å¢åŠ è®¾å¤‡/äººå‘˜ï¼‰ï¼Œå¯æå‡æ•´ä½“äº§èƒ½ã€‚
                        `;
                        // åˆ†æåæ¸…ç©ºå·¥åºæ•°æ®ï¼Œæ–¹ä¾¿é‡æ–°è¾“å…¥
                        processes = {};
                    } else {
                        assistantReply = 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥å·¥åºè¾“å…¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼';
                    }
                }
            } else {
                // è§£æç”¨æˆ·è¾“å…¥çš„å·¥åºï¼ˆæ ¼å¼ï¼šå·¥åºå,è€—æ—¶,å‰ç½®1,å‰ç½®2ï¼‰
                const parts = content.trim().split(',').map(item => item.trim());
                if (parts.length < 2) {
                    assistantReply = 'è¾“å…¥æ ¼å¼ä¸å¯¹å“¦ï¼æ­£ç¡®æ ¼å¼ï¼šå·¥åºå,è€—æ—¶ï¼ˆä¾‹å¦‚ï¼šæ³¨å¡‘ç¯åº§,5ï¼‰ï¼Œæœ‰å‰ç½®å·¥åºå¯åŠ åœ¨åé¢ï¼ˆä¾‹å¦‚ï¼šç„Šæ¥çº¿è·¯,8,æ³¨å¡‘ç¯åº§ï¼‰ã€‚';
                } else {
                    const processName = parts[0];
                    const duration = parseFloat(parts[1]);
                    const predecessors = parts.slice(2).filter(p => p); // è¿‡æ»¤ç©ºå‰ç½®å·¥åº

                    // éªŒè¯è€—æ—¶æ˜¯å¦ä¸ºæ­£æ•°
                    if (isNaN(duration) || duration <= 0) {
                        assistantReply = `â€œ${processName}â€çš„è€—æ—¶å¿…é¡»æ˜¯æ­£æ•°ï¼Œè¯·é‡æ–°è¾“å…¥ï¼`;
                    } else {
                        // éªŒè¯å‰ç½®å·¥åºæ˜¯å¦å·²å­˜åœ¨
                        const invalidPre = predecessors.filter(p => !processes[p]);
                        if (invalidPre.length > 0) {
                            assistantReply = `â€œ${processName}â€çš„å‰ç½®å·¥åº${invalidPre.join('ã€')}è¿˜æ²¡æ·»åŠ ï¼Œè¯·å…ˆæ·»åŠ è¿™äº›å·¥åºï¼`;
                        } else {
                            // ä¿å­˜å·¥åº
                            processes[processName] = [duration, predecessors];
                            assistantReply = `âœ… å·²æ·»åŠ å·¥åºï¼š
                            åç§°ï¼š${processName}
                            è€—æ—¶ï¼š${duration} åˆ†é’Ÿ
                            å‰ç½®å·¥åºï¼š${predecessors.length > 0 ? predecessors.join('ã€') : 'æ— '}
                            ï¼ˆå¯ç»§ç»­æ·»åŠ å…¶ä»–å·¥åºï¼Œè¾“å…¥â€œå¼€å§‹åˆ†æâ€è·å–ç»“æœï¼‰`;
                        }
                    }
                }
            }

            // 3. æ˜¾ç¤ºåŠ©æ‰‹å›å¤
            setTimeout(() => { // åŠ ä¸€ç‚¹å»¶è¿Ÿï¼Œæ¨¡æ‹Ÿâ€œæ€è€ƒâ€è¿‡ç¨‹ï¼Œæ›´è‡ªç„¶
                const assistantMessage = document.createElement('div');
                assistantMessage.className = 'message assistant';
                // æ›¿æ¢æ¢è¡Œç¬¦ä¸º<br>ï¼Œè®©å›å¤æ ¼å¼æ›´æ¸…æ™°
                assistantMessage.innerHTML = assistantReply.replace(/\n/g, '<br>');
                messagesContainer.appendChild(assistantMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 300);
        }

        // ç»‘å®šå‘é€äº‹ä»¶
        sendBtn.addEventListener('click', () => {
            if (input.value.trim() !== '') {
                sendMessage(input.value.trim());
                input.value = '';
            }
        });

        // å›è½¦å‘é€
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value.trim() !== '') {
                sendMessage(input.value.trim());
                input.value = '';
            }
        });

        // é¡µé¢åŠ è½½æ—¶å‘é€æ¬¢è¿æ¶ˆæ¯
        window.onload = () => {
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'message assistant';
            welcomeMsg.innerHTML = 'ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®ä½ åˆ†æå°ç¯ç”Ÿäº§çš„ç“¶é¢ˆå·¥åºï½<br>è¯·æŒ‰æç¤ºæ ¼å¼è¾“å…¥å·¥åºï¼Œå…¨éƒ¨è¾“å…¥åæ•²â€œå¼€å§‹åˆ†æâ€å³å¯ã€‚';
            messagesContainer.appendChild(welcomeMsg);
        };
    </script>
</body>
</html>
